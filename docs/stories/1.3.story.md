# Story 1.3: CLI Interface Foundation

## Status
Ready for Review

## Story
**As a** user,
**I want** a simple command-line interface,
**so that** I can run analyses with different parameters.

## Acceptance Criteria
1. Basic argparse CLI with --input, --output, --config flags
2. --dry-run flag that validates input without processing
3. --verbose flag that shows detailed progress
4. Graceful error handling with helpful messages
5. Exit codes: 0=success, 1=error, 2=partial completion
6. Help text includes concrete usage examples
7. Additional flags: `--models`, `--max-items`, `--time-limit`, `--budget`, `--public-report {on,off}`

## Tasks / Subtasks
- [x] Extend existing `cli.py` with new "analyze" command (AC: 1)
  - [x] Add argparse subparsers for commands: "load" (existing), "analyze" (new)
  - [x] Implement --input, --output, --config flags for analyze command
  - [x] Ensure backward compatibility with existing "load" command
- [x] Integrate Story 1.2's `analyze_questions()` function (AC: 1, 3)
  - [x] Import `src/analysis/heuristics.py::analyze_questions`
  - [x] Wire --input to load dataset, then pass to analyze_questions
  - [x] Wire --output to save_path parameter
  - [x] Handle --verbose flag to control show_progress parameter
- [x] Implement --dry-run validation logic (AC: 2)
  - [x] Validate input file exists and is readable
  - [x] Validate output directory is writable
  - [x] Load and validate dataset format without processing
  - [x] Report validation results and exit without analysis
- [x] Add comprehensive error handling (AC: 4)
  - [x] Wrap main execution in try-except blocks
  - [x] Handle FileNotFoundError with message: "Error: Input file '{path}' not found"
  - [x] Handle PermissionError with message: "Error: Permission denied accessing '{path}'"
  - [x] Handle json.JSONDecodeError with message: "Error: Invalid JSON format in '{path}'"
  - [x] Handle ValueError for invalid data with message: "Error: Invalid data format - {details}"
  - [x] Handle KeyboardInterrupt gracefully with message: "Analysis interrupted by user"
  - [x] Log all errors to both console (user-friendly) and log file (with full traceback)
- [x] Implement exit code system (AC: 5)
  - [x] Return 0 on successful completion
  - [x] Return 1 on error with appropriate error message
  - [x] Return 2 for partial completion (future stories, placeholder for now)
- [x] Create comprehensive help text (AC: 6)
  - [x] Add detailed descriptions for each flag
  - [x] Include 3-5 concrete usage examples in help epilog
  - [x] Document expected input formats and output structure
- [x] Implement additional analysis flags (AC: 7)
  - [x] Add --models flag (store as list, accept but ignore for now - print "Model selection not yet implemented")
  - [x] Add --max-items flag (integer, actually limit questions processed using list slicing)
  - [x] Add --time-limit flag (integer seconds, accept but ignore - print "Time limit not yet implemented")
  - [x] Add --budget flag (float, accept but ignore - print "Budget limits not yet implemented")
  - [x] Add --public-report flag with choices=['on', 'off'] (accept but ignore - always generate full report for now)
- [x] Write unit tests in `tests/test_cli_analyze.py` (AC: 1-7)
  - [x] Test command parsing for all flags
  - [x] Test --dry-run validation logic
  - [x] Test error handling and exit codes
  - [x] Test integration with analyze_questions
  - [x] Mock file I/O and dataset loading for isolated testing

## Dev Notes

### Previous Story Insights
From Story 1.2 implementation (Status: Done):
- `analyze_questions()` function available in `src/analysis/heuristics.py`
- Function signature: `analyze_questions(questions: List[Question], show_progress: bool = False, save_path: Optional[Path] = None, dataset_path: Optional[Path] = None, dataset_hash: Optional[str] = None, debug: bool = False) -> HeuristicReport`
- Returns HeuristicReport dataclass with fields: method, timestamp, config_hash (currently null), dataset, results, performance
- Progress bar controlled by show_progress parameter using tqdm (requires tqdm in requirements.txt)
- Results saved to JSON format when save_path provided
- LongestAnswerHeuristic class implements the heuristic logic
[Source: Story 1.2 implementation verified]

### Source Tree Placement
- Main CLI entry point: `cli.py` (already exists at project root)
- Test file location: `tests/test_cli_analyze.py` (new file)
- Configuration: loads from `configs/default.json` by default
- Output directory: `results/` (relative to project root)
[Source: architecture/project-structure.md]

### Tech Stack Constraints
- CLI framework: argparse (built-in, no external deps)
- Configuration: dataclasses with JSON serialization (stdlib only)
- Progress bars: tqdm (already in requirements.txt)
- No additional dependencies should be added for CLI
[Source: architecture/tech-stack.md]

### Existing CLI Structure
Current `cli.py` implementation includes:
- Basic argparse setup with "load" command
- Config loading from JSON using `AppConfig.from_json()`
- Logging setup via `setup_logging()`
- Determinism settings via `set_determinism()`
- Dataset loading via `load_dataset()`
The new "analyze" command should follow similar patterns.
[Source: Direct code inspection of cli.py]

### Data Flow Integration
- Input: Dataset path → `load_dataset()` → List[Question]
- Processing: Questions → `analyze_questions()` → HeuristicReport
- Output: HeuristicReport → JSON file in `results/` directory
[Source: architecture/data-flow-architecture.md#processing-pipeline-stages]

### Error Handling Patterns
- Use structured logging for all errors (logger.error())
- Provide user-friendly messages to console
- Include technical details in log files
- Follow fail-graceful patterns: validate early, handle errors gracefully
[Source: architecture/fail-graceful-architecture-patterns.md]

### Configuration Management
- AppConfig loaded from JSON files in `configs/` directory
- Config includes: logging settings, determinism controls, data mappings
- ID salt can be overridden via command line (--id-salt flag already exists)
[Source: Direct code inspection and architecture/tech-stack.md]

### Testing Standards
- Framework: unittest (stdlib, per tech stack)
- Test file location: `tests/test_cli_analyze.py` (avoid conflict with test_cli_smoke.py)
- Use mocking for file I/O operations to avoid test dependencies
- Mock analyze_questions to avoid dependency on tqdm
- Test should run quickly (<1 second per test)
- Follow existing test patterns from `tests/test_heuristics.py`
[Source: architecture/testing-strategy.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-09-13 | 1.1 | Fixed test file naming, clarified placeholders, added error scenarios, verified Story 1.2 | Sarah (PO) |
| 2025-09-13 | 1.2 | Implemented all tasks, created tests, validated functionality | James (Dev) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- CLI successfully extended with analyze subcommand
- All 12 unit tests passing
- Full test suite (25 tests) passing
- Verified dry-run functionality with sample dataset
- Verified full analysis with output generation

### Completion Notes List
- Successfully extended CLI with analyze command using argparse subparsers
- Integrated analyze_questions from Story 1.2's heuristics module
- Implemented all required flags including placeholders for future features
- Added comprehensive error handling with specific messages for each error type
- Implemented exit codes (0=success, 1=error, 2=partial reserved for future)
- Created detailed help text with 5 usage examples
- Wrote comprehensive unit tests covering all acceptance criteria
- Maintained backward compatibility with existing load command
- All tests passing (25 total in test suite)

### File List
- Modified: cli.py
- Created: tests/test_cli_analyze.py

## QA Results

### Review Date: 2025-09-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The CLI implementation demonstrates solid engineering practices with comprehensive error handling, clear separation of concerns, and extensive test coverage. The argparse-based CLI follows Python best practices and integrates cleanly with the existing heuristics module from Story 1.2. All 7 acceptance criteria have been fully implemented with appropriate validation and user feedback mechanisms.

### Refactoring Performed

No refactoring required - the implementation is clean and follows established patterns. The code appropriately handles all error scenarios and provides clear user feedback.

### Compliance Check

- Coding Standards: ✓ Follows Python conventions, proper error handling patterns
- Project Structure: ✓ CLI at root, tests in tests/, follows architecture guidelines
- Testing Strategy: ✓ 12 comprehensive unit tests with appropriate mocking
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and tested

### Improvements Checklist

All items were minor and do not block story completion:

- [x] Verified all error handling paths have both user messages and logging
- [x] Confirmed test coverage for all CLI flags
- [x] Validated integration with Story 1.2's analyze_questions function
- [ ] Consider extracting validation logic to separate function (future refactor)
- [ ] Add integration test with actual file I/O (can be added in future story)
- [ ] Ensure tqdm is installed before running analyze with --verbose

### Security Review

No security concerns identified. The implementation:
- Properly validates file paths without executing user input
- Uses Path objects for safe file operations
- No command injection vulnerabilities
- Appropriate permission checking for output directories

### Performance Considerations

Performance is appropriate for CLI tool:
- Efficient list slicing for --max-items limitation
- No unnecessary file operations during dry-run
- Proper early validation to fail fast

### Files Modified During Review

No files modified - implementation meets quality standards.

### Gate Status

Gate: PASS → docs/qa/gates/1.3-cli-interface-foundation.yml
Risk profile: Low-risk CLI extension with comprehensive test coverage
NFR assessment: All non-functional requirements satisfied

### Recommended Status

✓ Ready for Done
(Story implementation complete, all ACs met, tests passing)