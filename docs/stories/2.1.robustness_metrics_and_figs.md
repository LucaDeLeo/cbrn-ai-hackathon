Status: Ready for Review

Story
- As a robustness analyst,
- I want paraphrase/perturb consistency metrics in aggregation with small figures,
- so that I can quantify fragility and deltas across robustness tasks.

Acceptance Criteria
- `robustcbrn.analysis.aggregate.aggregate_main` computes and includes in `summary.json` when present in logs:
  - `paraphrase_consistency`: from `consistency_at_k(df, task_name='paraphrase_consistency')`
  - `perturbation_fragility`: from `fragility_score(df, task_name='perturbation_stability')`
  - `paraphrase_delta_accuracy`: from `delta_accuracy(df, task_name='paraphrase_consistency')`
- Figures under `artifacts/figs/` are saved if data present:
  - `paraphrase_consistency.png` (bar + CI),
  - `perturbation_fragility.png` (bar + CI).
- When logs lack these tasks, aggregation completes without error and sets metrics to zeros with `n=0`.
- `make aggregate` writes updated `artifacts/results/summary.json` and includes new keys.

Tasks / Subtasks
- [x] Extend `aggregate_main` to import helpers from `robustcbrn.analysis.robustness` and compute metrics guarded by presence checks.
- [x] Extend or reuse `robustcbrn.analysis.figs` utilities to draw CI bars for the two metrics.
- [x] Write resulting images to `get_paths().figs_dir` with canonical filenames.
- [x] Update `docs/results/results-template.md` to reference these figures and keys from `summary.json`.

Dev Agent Record
- Agent Model Used: BMAD Dev Agent (James)

- Debug Log References:
  - Ran test suite: 131 passed, 5 skipped (local).

- Completion Notes List:
  - Aggregator now outputs `paraphrase_consistency`, `perturbation_fragility`, `paraphrase_delta_accuracy` into `summary.json`.
  - Figures saved when data present: `artifacts/figs/paraphrase_consistency.png`, `artifacts/figs/perturbation_fragility.png`.
  - Results template updated to include new metrics and figure references.
  - Added focused unit tests validating new metrics and behavior for missing vs present data.
  - Documented repo-wide Ruff cleanup plan in `docs/LINT_CLEANUP_PLAN.md`.

- File List:
  - modified: `robustcbrn/analysis/aggregate.py`
  - modified: `docs/results/results-template.md`
  - added: `tests/test_aggregate_robustness_metrics.py`
  - added: `docs/LINT_CLEANUP_PLAN.md`

Dev Notes
- Reference files: `robustcbrn/analysis/aggregate.py`, `robustcbrn/analysis/robustness.py`, `robustcbrn/analysis/figs.py`.
- Use existing bootstrap/CIs; follow patterns used for benign pairs figure.
- Ensure no circular imports (lazy imports as needed).

Testing
- Run `scripts/run_robustness_suite.sh` on sample and then `make aggregate`; verify `summary.json` contains new keys and figures are created.
- Unit test: small DataFrame fixtures to validate function outputs when populated vs empty.

Change Log
- 2025-09-14 v1 Draft initial story (SM)
- 2025-09-14 v2 Implemented aggregation metrics and figures; updated template (Dev)
- 2025-09-14 v3 Added unit tests for robustness metrics; updated story record (Dev)

## QA Results

### Review Date: 2025-09-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- AC verified: aggregator computes `paraphrase_consistency`, `perturbation_fragility`, and `paraphrase_delta_accuracy` with robust defaults when tasks are absent. Keys are written into `artifacts/results/summary.json`.
- Figure generation follows canonical names and locations via `get_paths().figs_dir` and only writes when `n>0`. Tests verify zeroed metrics and no figures when tasks are missing; a populated case validates metric math and stability.
- Implementation is defensive: presence checks, numeric coercion, and bootstrap CIs avoid NaN/Inf propagation. Imports are arranged to prevent circular dependencies.
- Interfaces align with existing config (`Paths`) and Makefile target (`make aggregate`). No security-sensitive surfaces added.

### Refactoring Performed
- None. Review-only; no code changes required.

### Compliance Check
- Coding Standards: ✓ (consistent style; Ruff target py310 matches usage)
- Project Structure: ✓ (new logic isolated under `analysis/` with clear responsibilities)
- Testing Strategy: ✓ (unit tests cover missing/present data behavior for new metrics)
- All ACs Met: ✓

### Improvements Checklist
- [ ] Add a warning/log on plotting failures (currently silenced) to aid diagnostics in headless environments.
- [ ] Consider asserting figure creation in tests when a display-safe backend is available (currently skipped to keep CI robust).
- [ ] Add a brief note in `RESULTS_TEMPLATE.md` describing when figures may be omitted (e.g., `n=0`).
- [ ] Optionally parametrize tests with multiple models/seeds to cover grouping behavior.

### Security Review
- No new external I/O or privileged operations introduced. JSON log parsing remains constrained to known fields; figure paths are derived from config and created under repo-controlled directories.

### Performance Considerations
- Log discovery uses recursive `rglob("*.json")`; acceptable for expected log volumes. Consider shallow globbing or task-name filters only if scale demands.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/2.1-robustness_metrics_and_figs.yml
Risk profile: docs/qa/assessments/2.1-risk-20250914.md
NFR assessment: docs/qa/assessments/2.1-nfr-20250914.md

### Recommended Status
[✓ Ready for Done]

### Review Date: 2025-09-14 (follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Follow-up fix applied to remove pandas FutureWarning in abstention/overconfidence calculation; no behavioral changes.

### Refactoring Performed
- **File**: robustcbrn/analysis/aggregate.py
  - **Change**: Coerce `confidence` to numeric via `pd.to_numeric(..., errors="coerce")` before `fillna(-1.0)`; compute `abst_mask` using numeric comparison and `pred_index.isna()`.
  - **Why**: Avoid pandas future downcasting behavior change and eliminate warning; future-proof aggregation.
  - **How**: Replaced `df["confidence"].fillna(-1)` with `pd.to_numeric(df.get("confidence"), errors="coerce").fillna(-1.0)`; preserved logic and output.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (all tests pass, no warnings)
- All ACs Met: ✓

### Files Modified During Review
- robustcbrn/analysis/aggregate.py

### Gate Status
Gate: PASS (unchanged) → docs/qa/gates/2.1-robustness_metrics_and_figs.yml

### Recommended Status
[✓ Ready for Done]
