# Story 2.1: Position Bias Analysis

## Status
Done

## Story
**As a** researcher,
**I want** to detect position preference patterns,
**so that** I can identify if models systematically favor certain option positions.

## Acceptance Criteria
1. Calculate frequency distribution of correct answers across positions A,B,C,D
2. Chi-square test for uniform distribution (implemented from scratch with NumPy)
3. Identify questions where correct answer position is predictive
4. Generate position swap variants (A→D, B→C, etc.) for testing
5. Output includes observed vs expected frequencies with p-values
6. Docstring includes mathematical formula for chi-square calculation
7. Automated correctness checks validate option reindexing and label remapping after permutations (unit test with checksums)

## Tasks / Subtasks
- [x] Implement chi-square goodness-of-fit with accurate p-value via regularized upper incomplete gamma (series + continued fraction) (AC: 2, 5, 6)
- [x] Add clear χ² docstring with formula, df, and method notes (AC: 6)
- [x] Correct predictive-question identification to require significance and unique max (tie-safe) (AC: 3)
- [x] Fix dataset metadata aggregation for `choice_counts` (AC: 5)
- [x] Keep JSON output stable and include observed/expected, statistic, p-value, significance flag (AC: 5)
- [x] Deduplicate implementation by re-exporting from `src/statistical/position_bias.py` in `position_bias_working.py` (structure cleanup)
- [x] Strengthen tests: swap correctness asserts original correct choice preserved; add docstring formula presence check (AC: 7, 6)
- [x] Update QA gate with decision and rationale

## Dev Notes

### Relevant Source Tree
- Core implementation: `src/statistical/position_bias.py`
- CLI integration (imports re-export): `position_bias_working.py` → `src/statistical/position_bias.py`
- CLI command: `cli.py` subcommand `position-bias`
- Tests: `tests/test_position_bias.py`

### Architecture References
- Project structure and module placement [Source: architecture/project-structure.md]
- Output schemas and reporting expectations [Source: architecture/output-schemas.md]
- Testing strategy and unittest patterns [Source: architecture/testing-strategy.md]
- Fail‑graceful patterns for input validation and file I/O [Source: architecture/fail-graceful-architecture-patterns.md]

### Notes
- P‑value now computed without SciPy using regularized upper incomplete gamma; uniform distributions produce p≈1.0, biased examples produce small p as expected.
- Predictive identification skips ties to avoid defaulting to position ‘A’ on uniform groups.
- Swap variants include checksum; tests ensure remapped answer points to the same original correct choice text.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Implemented statistical fixes, tests, and cleanup; story recorded | Dev Agent |

## Dev Agent Record

### Completion Notes List
- Replaced p‑value approximation with accurate incomplete‑gamma based computation.
- Added χ² formula to docstring and a lightweight docstring presence test.
- Enforced unique‑max requirement for predictive questions and grouped by choice count with full label set.
- Fixed `choice_counts` aggregation and maintained JSON output compatibility.
- Consolidated implementations via re‑export to avoid drift.

### File List
- Modified: `src/statistical/position_bias.py`
- Modified: `tests/test_position_bias.py`
- Modified: `docs/qa/gates/2.1-position-bias-analysis.yml`
- Added/Replaced (re‑export): `position_bias_working.py`

## QA Results
Gate: PASS → docs/qa/gates/2.1-position-bias-analysis.yml
Notes: P‑value correctness verified; predictive tie‑handling added; metadata fixed; implementation deduplicated.

