Status: Done

Story
- As a diagnostics user,
- I want longest-answer and position-bias heuristic summaries when metadata is available,
- so that I can quickly assess shortcut exploitation tendencies.

Acceptance Criteria
- `aggregate_main` (or a helper it calls) computes a `heuristics_summary` object with at least:
  - `longest_answer_acc` when choice lengths are available (or 0.0 with `note` when unavailable),
  - `position_bias_rate` when choice index positions are available (or 0.0 with `note` when unavailable).
- The implementation uses only safe metadata (lengths, indices) and never uses raw text in public artifacts.
- When metadata is absent, the keys exist with zeros and an explanatory note; no errors are thrown.
- `docs/results/report.md` and `docs/results/results-template.md` reflect these metrics where appropriate.

Tasks / Subtasks
- [x] Implement `longest_answer_heuristic(df)` to compute accuracy of a "pick-longest" heuristic when `choice_lengths` or equivalent metadata is present.
- [x] Implement `position_bias_heuristic(df)` computing win rates of fixed position choices (e.g., last or first) if `pred_index` and `num_choices` or similar metadata present.
- [x] Add `heuristics_summary` to `summary.json`.
- [x] Document metadata expectations and absence behavior in `docs/getting-started/usage.md`.

Dev Agent Record
- Agent Model Used: BMAD Dev Agent (James)

- Debug Log References:
  - Ran unit tests locally; added `tests/test_heuristics_summary.py` covering missing metadata and synthetic positive cases.

- Completion Notes List:
  - Added safe metadata fields (`choice_lengths`, `num_choices`) to log parsing in `aggregate.py`.
  - Implemented `longest_answer_heuristic` (item-collapsed, bootstrap CIs) and `position_bias_heuristic` (first/last fixed positions; requires `num_choices` or `choice_lengths`).
  - Wired `heuristics_summary` into `summary.json` with robust defaults and notes when metadata is absent.
  - Updated `docs/results/results-template.md` to include position‑bias rate and `docs/getting-started/usage.md` to document metadata expectations.

- File List:
  - modified: `robustcbrn/analysis/aggregate.py`
  - modified: `docs/results/results-template.md`
  - modified: `docs/results/report.md`
  - modified: `docs/getting-started/usage.md`
  - added: `tests/test_heuristics_summary.py`
  - added: `tests/test_aggregate_heuristics_integration.py`

Dev Notes
- Reference files: `robustcbrn/analysis/aggregate.py` (has placeholder for longest), `robustcbrn/qa/filters.py` (length helpers), logs format from Inspect.
- Consider joining per-item static metadata if available in a separate safe file (ids + numeric features only).

Testing
- Fixture DataFrame with synthetic `choice_lengths`, `pred_index`, and `target_index` to validate non-zero outputs.
- Run `make sample` and confirm `heuristics_summary` appears with zeros and `note` when metadata is missing.

Change Log
- 2025-09-14 v1 Draft initial story (SM)
- 2025-09-14 v2 Implemented heuristics summary and docs; added tests (Dev)
- 2025-09-14 v3 Added integration test for aggregator heuristics summary (Dev)
## QA Results

### Review Date: 2025-09-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Implementation cleanly adds safe, metadata-only heuristics into `aggregate.py` with robust default behavior and CI-friendly tests. Functions handle missing fields defensively and avoid raw text in outputs. Docs and templates reference the new metrics appropriately.

### Refactoring Performed
- None. No code changes were required during QA; review was static.

### Compliance Check
- Coding Standards: ✓ No violations observed; repository lacks a dedicated `docs/coding-standards.md`.
- Project Structure: ✓ Additions align with existing analysis/test layout.
- Testing Strategy: ✓ Unit and integration tests added for heuristics; behavior under missing metadata covered.
- All ACs Met: ✓ Heuristics summary computed; safe metadata only; zeros with explanatory notes when absent; docs updated.

### Improvements Checklist
- [ ] Consider adding an alphabetical-preference heuristic (optional, not required by this story) to match template mention.
- [ ] Add a CI check asserting `heuristics_summary` keys always present in `summary.json` (defense-in-depth).
- [ ] Document any alternative key names supported for lengths (e.g., `choice_char_lengths`) explicitly in `USAGE.md`.

### Security Review
- PASS. Public artifacts remain aggregate-only; heuristics use numeric metadata only. No raw text or per-item exploit labels are emitted.

### Performance Considerations
- No concerns. Computations are linear in rows and negligible relative to aggregation.

### Files Modified During Review
- None (static review only).

### Gate Status
Gate: PASS → docs/qa/gates/3.1-heuristics_summary.yml
Risk profile: docs/qa/assessments/3.1-risk-20250914.md (not generated in this review)
NFR assessment: docs/qa/assessments/3.1-nfr-20250914.md (not generated in this review)

### Recommended Status
[✓ Ready for Done]
