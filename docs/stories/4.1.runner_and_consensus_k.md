Status: Done

Story
- As a user running full suites,
- I want a single orchestration script and a configurable consensus threshold,
- so that I can run everything consistently and tune consensus without code changes.

Acceptance Criteria
- `scripts/run_all.sh` orchestrates MCQ full, MCQ choices-only, Cloze (per mode), benign pairs, paraphrase, and perturbation tasks with one config (`.env` + env overrides).
- Progress messages and a run time summary are printed for major phases in `scripts/run_evalset.sh` and `run_all.sh`.
- Majority consensus threshold `k` is configurable via env/flag (e.g., `CONSENSUS_K`) and is wired into aggregation and any consensus calculations.
- `make run` and `scripts/run_evalset.sh` pass `CONSENSUS_K` through to `robustcbrn.analysis.aggregate` or a CLI param.
- Docs updated to describe the new script and `k` parameter.

Tasks / Subtasks
- [x] Add `scripts/run_all.sh` using existing scripts as building blocks; ensure idempotent log dirs and results aggregation at the end.
- [x] Add `--k` to `robustcbrn.analysis.aggregate` CLI and thread to `majority_consensus(df, k)`.
- [x] Update `scripts/run_evalset.sh` to show simple phase timing and a short summary at the end (elapsed seconds, models, seeds, subset).
- [x] Update `docs/getting-started/usage.md` with examples for `run_all.sh` and `CONSENSUS_K`.

Dev Notes
- Reference: `Makefile`, `scripts/run_evalset.sh`, `robustcbrn/analysis/aggregate.py`.
- Keep default `k=2` for backward compatibility.

Testing
- Dry run with `SUBSET=32` to ensure end-to-end orchestration completes and summary prints.
- Unit test `aggregate.cli` parses and passes `--k` correctly.

Change Log
- 2025-09-14 v1 Draft initial story (SM)
- 2025-09-14 v2 Implemented runner and CONSENSUS_K integration (Dev)

Dev Agent Record
- File List
  - robustcbrn/analysis/aggregate.py
  - scripts/run_evalset.sh
  - scripts/run_all.sh
  - scripts/run_sample.sh
  - scripts/run_robustness_suite.sh
  - scripts/run_robustness_suite_parallel.sh
  - docs/getting-started/usage.md
  - tests/test_aggregate_cli_k.py
- Completion Notes
  - Added `--k` CLI and threaded through scripts; created `run_all.sh`; updated usage; added focused unit test.
- Debug Log References
  - tests/test_aggregate_cli_k.py: passes locally.
 - Agent Model Used
   - James (dev)



QA Results
- Gate Decision: PASS (with minor concerns)
- Rationale: Acceptance criteria appear satisfied based on code inspection and docs. `CONSENSUS_K` threads from env/CLI into `aggregate` and is used in `majority_consensus`. `scripts/run_evalset.sh` prints clear progress and a final elapsed summary; `scripts/run_all.sh` orchestrates the full suite and prints phase markers and a final summary. `docs/getting-started/usage.md` documents `run_all.sh` and the `k` parameter; a unit test validates `--k` behavior.
- Traceability Check
  - Orchestration script: `scripts/run_all.sh` runs MCQ full, MCQ choices-only, Cloze (per `CLOZE_MODE`), benign pairs, paraphrase, and perturbation; finishes with aggregation.
  - Progress + summary: `scripts/run_evalset.sh` shows phase logs and end-of-run summary; `scripts/run_all.sh` shows phase headers and final summary.
  - Configurable k: `robustcbrn.analysis.aggregate.cli` exposes `--k` with default from `CONSENSUS_K`; `scripts/run_evalset.sh` passes `--k "$CONSENSUS_K"` to the aggregator. `Makefile run` delegates to `run_evalset.sh`, so k is honored when set in env.
  - Docs: `docs/getting-started/usage.md` includes examples for `run_all.sh` and `CONSENSUS_K` usage.
- Risks / Concerns
  - Model normalization inconsistency: In `scripts/run_all.sh` benign pairs phase, `--model "$M"` is passed without provider-prefix normalization, unlike paraphrase/perturbation phases that use `IM=$(normalize_model ...)`. This may cause provider mismatch for HF models. Suggest: use the same `IM` normalization for benign pairs.
  - Inspect arg style inconsistency: Benign pairs uses `--arg dataset_path=...` while other Inspect calls use `-T dataset_path=...`. Functionally likely equivalent, but unify to reduce confusion and avoid CLI drift.
  - Optional clarity: `Makefile aggregate` does not pass `--k`; it relies on the aggregator's env default. Consider honoring `CONSENSUS_K` explicitly or documenting that `make aggregate` uses env if set.
  - Nice-to-have: `scripts/run_all.sh` could print per-phase elapsed times to better match the "major phases" timing intent; not required for this story.
- Test Suggestions
  - Add a test that `CONSENSUS_K` env is respected when `--k` is omitted (CLI default path).
  - Add a small integration smoke test for `scripts/run_evalset.sh` that verifies the final summary line includes the configured `k` value.
  - Add a targeted check that `majority_consensus(df, k)` only affects `choices_only` tasks and leaves others untouched.
- NFR / Testability
  - Observability is good (progress + summary). Testability is strong with a clear CLI seam and pure helpers. Performance is adequate for log scan; no security concerns surfaced (no raw text in public artifacts).

- QA Follow-up (2025-09-14)
  - Addressed items: normalized benign-pairs model via `normalize_model`, unified Inspect args to `-T`, `Makefile aggregate` now honors `CONSENSUS_K` via `--k` when set, and per-phase elapsed timing added to `scripts/run_all.sh`.
  - Tests: `pytest` passed locally (135 passed, 5 skipped).
  - Final Gate Decision: PASS
