Status: Done

Story
- As a maintainer,
- I want schema validation pre-eval and clearer release safety controls,
- so that custom datasets fail fast and artifacts remain compliant.

Acceptance Criteria
- Pre-eval schema checks run in `scripts/run_evalset.sh` and fail with actionable messages for invalid datasets (MCQ/choices-only), pointing to docs on expected schema.
- `docs/USAGE.md` includes an explicit section on dataset schema for MCQ (required fields/types).
- `scripts/validate_release.sh` supports an allowlist of safe metadata columns via env (e.g., `VALIDATE_SAFE_COLUMNS=...`) and treats them as permitted in CSVs.
- `load_mcq_dataset` path guard behavior is documented in `docs/USAGE.md` or simplified to a clearer error; no surprising path errors.

Tasks / Subtasks
- [x] Add a CLI entry or small wrapper for `robustcbrn.utils.validation` to validate MCQ and choices-only files; call it from `run_evalset.sh` before eval loops.
- [x] Extend `validate_release.sh` to optionally whitelist columns (case-insensitive match at CSV boundaries) and document usage.
- [x] Update `docs/USAGE.md` with schema examples and common failure messages.
- [x] Review/simplify `load_mcq_dataset` path guard and adjust error messages for clarity.

Dev Notes
- Reference: `robustcbrn/utils/validation.py`, `scripts/run_evalset.sh`, `scripts/validate_release.sh`.
- Ensure exit codes differentiate schema vs release policy failures.

Testing
- Create a minimal invalid JSONL to trigger validation and verify error guidance.
- Run `bash scripts/validate_release.sh` on artifacts to confirm safe-column allowlist works as intended.

Change Log
- 2025-09-14 v1 Draft initial story (SM)
- 2025-09-14 v2 Implemented schema validation CLI, release allowlist, path-guard simplification, and docs (Dev)

Dev Agent Record
- File List
  - robustcbrn/cli/__init__.py
  - robustcbrn/cli/validate_dataset.py
  - robustcbrn/tasks/common.py
  - scripts/run_evalset.sh
  - scripts/validate_release.sh
  - docs/USAGE.md
  - tests/test_validate_dataset_cli.py
  - tests/test_validate_release_allowlist.py
- Completion Notes
  - Added `validate_dataset` CLI and wired into `run_evalset.sh` pre-loop; prints actionable messages and exits with code 4 on schema failures, pointing to `docs/USAGE.md#dataset-schema`.
  - Extended `validate_release.sh` to support `VALIDATE_SAFE_COLUMNS` allowlist for CSV headers (boundary + case-insensitive); kept `exploitable` always forbidden. Normalized to use repo venv python with `PYTHONPATH` so it runs from any CWD.
  - Simplified `load_mcq_dataset` path guard (removed surprising project-bounds check); clarified path behavior in docs.
  - Updated `docs/USAGE.md` with MCQ/choices-only schemas, examples, common errors, and validator usage.
  - Exit codes now clearly differentiate: schema=4, policy content=2, QA thresholds=3.
- Debug Log References
  - tests/test_validate_dataset_cli.py: validates CLI failure mode and docs guidance.
  - tests/test_validate_release_allowlist.py: verifies CSV allowlist behavior end-to-end.
- Agent Model Used
  - James (dev)

QA Results
- Gate Decision: PASS
- Rationale: Acceptance criteria are implemented and verifiable. `scripts/run_evalset.sh` performs pre‑eval schema validation via the new CLI and exits with code 4 on schema failure, printing a pointer to `docs/USAGE.md#dataset-schema`. `docs/USAGE.md` documents MCQ and choices‑only schemas with examples. `scripts/validate_release.sh` supports a case‑insensitive `VALIDATE_SAFE_COLUMNS` allowlist for CSV headers while always forbidding `exploitable`. `load_mcq_dataset` path checks are simplified to clear file existence/type validation, and path behavior is documented.
- Traceability Check
  - Pre‑eval schema checks: `scripts/run_evalset.sh` calls `python -m robustcbrn.cli.validate_dataset --schema both "$DATASET"` and exits 4 on failure with docs pointer.
  - Docs schema section: `docs/USAGE.md` includes a Dataset Schema section covering MCQ required fields/types and choices‑only, with examples and common errors.
  - Release allowlist: `scripts/validate_release.sh` parses `VALIDATE_SAFE_COLUMNS`, matches headers at CSV boundaries case‑insensitively, and still blocks `exploitable`. JSON scans continue to forbid raw `question`/`choices` keys in public artifacts.
  - Path guard clarity: `robustcbrn/tasks/common.py:load_mcq_dataset` accepts absolute/relative paths with clear errors; `docs/USAGE.md` documents path behavior.
- Risks / Concerns
  - Scanner scope (low): The JSON `grep` patterns in `validate_release.sh` could theoretically flag benign keys if present in internal JSON. This is acceptable given current outputs; optionally scope to known artifact subpaths if noise appears.
- Test Suggestions
  - Add CLI negative tests: out‑of‑range MCQ answer (e.g., `"Z"` for 3 choices) → exit 4 with guidance; non‑string `choices` entries → exit 4.
  - Add a test asserting `exploitable` cannot be allowlisted in CSV headers.
  - Add a smoke test that `scripts/run_evalset.sh` returns 4 on an invalid dataset and prints the docs pointer.
- NFR / Testability
  - Security: PASS — release validator enforces two‑tier policy and never allows `exploitable`.
  - Reliability: PASS — distinct exit codes (schema=4, content policy=2, QA thresholds=3) and actionable messages.
  - Performance: PASS — O(n) JSONL scan and lightweight CSV header checks; negligible overhead.
  - Maintainability: PASS — clear CLI seam, simple shell integration, and documentation alignment.

- QA Follow-up (2025-09-14)
  - Implemented cross‑field MCQ validation in `robustcbrn.utils.validation.SchemaValidator` to ensure `answer` is valid/in‑range for provided `choices`.
  - Enforced string element types for `choices` within the schema validator; failures now report the offending index and type.
  - Added tests `test_validate_dataset_cli_out_of_range_answer` and `test_validate_dataset_cli_nonstring_choice_items`; ensured `exploitable` cannot be allowlisted in CSV headers.
  - Full test suite passes locally: 140 passed, 5 skipped.
  - Final Gate Decision: PASS (concerns addressed)
