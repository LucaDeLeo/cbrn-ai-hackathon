Status: Done

Story
- As a CI maintainer,
- I want a smoke test for the cloze HF path and better caching,
- so that CI validates critical paths quickly and runs faster.

Acceptance Criteria
- A small unit/smoke test exercises the cloze HF scorer on a tiny model or is guarded by a flag (`RUN_HF_CLOZE_SMOKE=1`) to skip in restricted environments.
- CI caches pip/uv to speed up repeated runs in `.github/workflows/ci.yml`.
- CI remains green in restricted/no-network mode (HF smoke test skips cleanly when disabled).

Tasks / Subtasks
- [x] Add `tests/test_cloze_hf.py` with parametrization:
  - [x] If `RUN_HF_CLOZE_SMOKE` is set, run a tiny model (e.g., `sshleifer/tiny-gpt2`) or mock HF components to verify `score_cloze_options` path and output shape.
  - [x] Else, assert importability and skip with reason.
- [x] Update CI workflow to add caching for pip/uv and optionally set `RUN_HF_CLOZE_SMOKE=0` by default.

Dev Agent Record
- Agent Model Used: James (dev)
- Debug Log References: .ai/debug-log.md
- Completion Notes:
  - Added HF cloze smoke test with mocked transformers path; defaults to skip via `RUN_HF_CLOZE_SMOKE`.
  - CI caches `~/.cache/pip` and `~/.cache/uv`; job env sets `RUN_HF_CLOZE_SMOKE=0`.
  - Local validation: 142 passed, 6 skipped.
- File List:
  - Added: `tests/test_cloze_hf.py`
  - Modified: `.github/workflows/ci.yml`

Dev Notes
- Reference: `robustcbrn/tasks/cloze_full.py`, new `cloze_logprob.py` wrapper, `.github/workflows/ci.yml`.
- Keep runtime under a few seconds when enabled; prefer mocking if network is not available.

Testing
- Local: run `RUN_HF_CLOZE_SMOKE=0 make test` and confirm skip; optionally enable with cached tiny model to verify path once.

Change Log
- 2025-09-14 v1 Draft initial story (SM)
- 2025-09-14 v2 Implemented smoke test + CI caching; set status Ready for Review (James)

QA Results
- Gate Decision: PASS
- Rationale: All ACs are satisfied. Guarded smoke test exists and is skipped by default in CI; CI now pins uv and caches pip/uv (and HF hub). A scheduled/manual job runs the cloze smoke regularly, and a new unit test validates `run_cloze_hf` logging.
- Traceability Check
  - Smoke test path: `tests/test_cloze_hf.py` includes `test_hf_cloze_smoke_mocked` using `monkeypatch` to stub `AutoTokenizer` and `AutoModelForCausalLM`; gated by `RUN_HF_CLOZE_SMOKE`.
  - Importability baseline: `test_hf_cloze_importable` covers `score_cloze_options` and `run_cloze_hf` imports with no network.
  - CI caching: `.github/workflows/ci.yml` caches `~/.cache/pip`, `~/.cache/uv`, and `~/.cache/huggingface` keyed by requirements files.
  - Default skip in CI: main job env sets `RUN_HF_CLOZE_SMOKE="0"`; separate `hf-smoke` job (manual/scheduled) sets it to `1` and runs cloze tests.
- Risks / Concerns
  - None blocking. Tiny-model path remains optional; current mocked approach meets ACs and keeps CI deterministic.
- Test Additions
  - Added `test_run_cloze_hf_emits_log` asserting a well-formed Inspect-like envelope is written by `run_cloze_hf`.
- NFR / Testability
  - Reliability: PASS — deterministic mocked scoring and clean skip behavior; scheduled job exercises the path.
  - Performance: PASS — mocked test is fast; caches reduce repeat CI time.
  - Maintainability: PASS — pinned uv version and clear job separation.
  - Security: PASS — no secrets/PII; no network when smoke disabled.

- QA Follow-up (2025-09-14)
  - Implemented: Pinned uv installer (`UV_VERSION=0.4.10`).
  - Implemented: Added cache for `~/.cache/huggingface` in CI.
  - Implemented: Added `hf-smoke` job (workflow_dispatch/scheduled) with `RUN_HF_CLOZE_SMOKE=1` and cloze-focused tests.
  - Implemented: New test `test_run_cloze_hf_emits_log` validates logging envelope.
  - Final Gate Decision: PASS
